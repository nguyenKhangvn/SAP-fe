<div class="stock-management-container">
    <h2 class="page-title">Qu·∫£n l√Ω t·ªìn kho</h2>

    <div class="loading-overlay" *ngIf="isLoading">
        <div class="spinner"></div>
        <p>ƒêang x·ª≠ l√Ω...</p>
    </div>

    <div class="card">
        <div class="card-header">
            <h3>C·∫≠p nh·∫≠t t·ªìn kho</h3>
        </div>
        <div class="card-body">
            <form [formGroup]="stockForm" (ngSubmit)="onSubmit()" class="stock-form">
                <div class="form-row">
                    <div class="form-group">
                        <label for="productCode">S·∫£n ph·∫©m</label>
                        <div class="select-wrapper">
                            <select id="productCode" formControlName="productCode" class="form-control">
                                <option value="">-- Ch·ªçn s·∫£n ph·∫©m --</option>
                                <option *ngFor="let product of products" [value]="product.code">
                                    {{ product.code }} - {{ product.name | slice:0:20 }}{{ product.name.length > 20 ?
                                    '...' : '' }}
                                    <span *ngIf="product.newStock !== undefined">
                                        (T·ªìn: {{ product.newStock }})
                                    </span>
                                </option>
                            </select>
                        </div>
                        <div class="error-message"
                            *ngIf="stockForm.get('productCode')?.invalid && stockForm.get('productCode')?.touched">
                            Vui l√≤ng ch·ªçn s·∫£n ph·∫©m
                        </div>
                    </div>

                    <div class="form-group">
                        <label for="type">Lo·∫°i giao d·ªãch</label>
                        <div class="select-wrapper">
                            <select id="type" formControlName="type" class="form-control">
                                <option value="import">Nh·∫≠p kho</option>
                                <option value="export">Xu·∫•t kho</option>
                            </select>
                        </div>
                    </div>

                    <div class="form-group">
                        <label for="quantity">S·ªë l∆∞·ª£ng</label>
                        <input type="number" id="quantity" formControlName="quantity" class="form-control" min="1">
                        <div class="error-message"
                            *ngIf="stockForm.get('quantity')?.errors?.['required'] && stockForm.get('quantity')?.touched">
                            Vui l√≤ng nh·∫≠p s·ªë l∆∞·ª£ng
                        </div>
                        <div class="error-message"
                            *ngIf="stockForm.get('quantity')?.errors?.['min'] && stockForm.get('quantity')?.touched">
                            S·ªë l∆∞·ª£ng ph·∫£i l·ªõn h∆°n 0
                        </div>
                    </div>
                </div>

                <div class="form-group">
                    <label for="notes">Ghi ch√∫</label>
                    <textarea id="notes" formControlName="notes" class="form-control" rows="2"></textarea>
                </div>

                <div class="product-details" *ngIf="selectedProduct">
                    <h4>Th√¥ng tin kho</h4>
                    <div class="details-row">
                        <span>T·ªìn kho hi·ªán t·∫°i:</span>
                        <span [ngClass]="getStockStatusClass(selectedProduct.newStock || 0)">
                            {{ selectedProduct.newStock || 0 }}
                        </span>
                    </div>
                    <div class="details-row">
                        <span>ƒê√£ nh·∫≠p:</span>
                        <span>{{ selectedProduct.imported || 0 }}</span>
                    </div>
                    <div class="details-row">
                        <span>ƒê√£ xu·∫•t:</span>
                        <span>{{ selectedProduct.exported || 0 }}</span>
                    </div>
                    <div class="details-row">
                        <span>Gi√° v·ªën:</span>
                        <span>{{ formatCurrency(selectedProduct.costPrice) }} ‚Ç´</span>
                    </div>
                    <div class="details-row">
                        <span>Gi√° b√°n:</span>
                        <span>{{ formatCurrency(selectedProduct.salePrice) }} ‚Ç´</span>
                    </div>
                </div>

                <div class="form-actions">
                    <button type="submit" class="btn-primary" [disabled]="stockForm.invalid">
                        {{ stockForm.get('type')?.value === 'import' ? 'Nh·∫≠p kho' : 'Xu·∫•t kho' }}
                    </button>
                </div>
            </form>
        </div>
    </div>

    <div class="card" *ngIf="selectedProduct">
        <div class="card-header">
            <h3>L·ªãch s·ª≠ t·ªìn kho - {{ selectedProduct.name }}</h3>
        </div>
        <div class="card-body">
            <table class="data-table">
                <thead>
                    <tr>
                        <th>Ng√†y</th>
                        <th>Lo·∫°i</th>
                        <th>S·ªë l∆∞·ª£ng</th>
                        <th>T·ªìn tr∆∞·ªõc</th>
                        <th>T·ªìn sau</th>
                        <th>Ghi ch√∫</th>
                    </tr>
                </thead>
                <tbody>
                    <tr *ngFor="let entry of stockHistory">
                        <td>{{ formatDate(entry.date) }}</td>
                        <td>
                            <span class="badge" [ngClass]="entry.type === 'import' ? 'badge-success' : 'badge-danger'">
                                {{ entry.type === 'import' ? 'Nh·∫≠p kho' : 'Xu·∫•t kho' }}
                            </span>
                        </td>
                        <td>{{ entry.quantity }}</td>
                        <td>{{ entry.oldStock }}</td>
                        <td>{{ entry.newStock }}</td>
                        <td>{{ entry.notes || '-' }}</td>
                    </tr>
                    <tr *ngIf="stockHistory.length === 0">
                        <td colspan="6" class="text-center">Kh√¥ng c√≥ l·ªãch s·ª≠ t·ªìn kho cho s·∫£n ph·∫©m n√†y</td>
                    </tr>
                </tbody>
            </table>
        </div>
    </div>

    <div class="card empty-state" *ngIf="!selectedProduct && !isLoading">
        <div class="card-body text-center">
            <div class="empty-icon">üì¶</div>
            <h4>Ch·ªçn m·ªôt s·∫£n ph·∫©m ƒë·ªÉ xem l·ªãch s·ª≠ t·ªìn kho</h4>
            <p>B·∫°n c√≥ th·ªÉ th√™m ho·∫∑c tr·ª´ s·ªë l∆∞·ª£ng t·ªìn kho sau khi ch·ªçn s·∫£n ph·∫©m</p>
        </div>
    </div>
</div>